<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat Room</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .user-info { color: #333; font-weight: bold; }
    #chat-box { border: 1px solid #ccc; background: #fff; padding: 10px; height: 400px; overflow-y: scroll; margin-bottom: 10px; }
    #message { width: 80%; padding: 10px; }
    #send { padding: 10px 20px; }
    .logout-btn { padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .logout-btn:hover { background-color: #c82333; }
  </style>
</head>
<body>
  <div class="header">
    <h2>WebSocket Chat Room</h2>
    <div>
      <span class="user-info" id="current-user">Welcome, Guest!</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
  
  <div id="chat-box"></div>
  <input type="text" id="message" placeholder="Type your message..." />
  <button id="send">Send</button>

  <script>
    const token = localStorage.getItem("session_token");
    const username = localStorage.getItem("username") || "Guest";
    
    if (!token) {
      window.location.href = "/quackquack/login";
    }

    // Display current user
    document.getElementById("current-user").textContent = `Welcome, ${username}!`;

    const ws = new WebSocket(`ws://${location.host}/quackquack/ws/chat?token=${token}`);
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("message");

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const messageElement = document.createElement("div");
      messageElement.textContent = data.message;
      messageElement.style.color = data.color;
      messageElement.style.fontWeight = "bold";
      messageElement.style.marginBottom = "5px";
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    ws.onopen = function(event) {
      const welcomeElement = document.createElement("div");
      welcomeElement.textContent = "Connected to chat room!";
      welcomeElement.style.color = "#28a745";
      welcomeElement.style.fontStyle = "italic";
      welcomeElement.style.marginBottom = "10px";
      chatBox.appendChild(welcomeElement);
    };

    ws.onclose = function(event) {
      const disconnectElement = document.createElement("div");
      disconnectElement.textContent = "Disconnected from chat room.";
      disconnectElement.style.color = "#dc3545";
      disconnectElement.style.fontStyle = "italic";
      disconnectElement.style.marginBottom = "10px";
      chatBox.appendChild(disconnectElement);
    };

    function sendMessage() {
      if (input.value.trim()) {
        ws.send(input.value.trim());
        input.value = "";
      }
    }

    document.getElementById("send").addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => e.key === "Enter" && sendMessage());

    async function logout() {
      try {
        const res = await fetch("/quackquack/auth/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_token: token })
        });
      } catch (error) {
        console.log("Logout request failed, but clearing local storage anyway");
      }
      localStorage.removeItem("session_token");
      localStorage.removeItem("username");
      window.location.href = "/quackquack/login";
    }
  </script>
</body>
</html>